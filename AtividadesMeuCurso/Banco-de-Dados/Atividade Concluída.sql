
CREATE DATABASE MERCEARIA;

CREATE TABLE FORNECEDOR (
   ID INT PRIMARY KEY,
   FORNOME VARCHAR(100) NOT NULL
);

CREATE TABLE PRODUTO (
   ID INT PRIMARY KEY,
   PRONOME VARCHAR(100) NOT NULL, 
   PROVLRUNITARIO FLOAT NOT NULL,
   ID_FORNECEDOR INT NOT NULL,
   CONSTRAINT FK_PROD FOREIGN KEY(ID_FORNECEDOR) 
      REFERENCES FORNECEDOR(ID)
);

CREATE TABLE CLIENTE (
   ID INT PRIMARY KEY,  
   CLINOME VARCHAR(100) NOT NULL,
   CLIENDERECO VARCHAR(40),
   CLITELEFONE VARCHAR(14)
);

CREATE TABLE NOTAFISCAL (
   ID INT PRIMARY KEY,
   NOTAEMISSAO DATE NOT NULL, 
   ID_CLIENTE INT NOT NULL,
   CONSTRAINT FK_NOTA FOREIGN KEY(ID_CLIENTE) 
      REFERENCES CLIENTE(ID)
);

CREATE TABLE NOTADETALHE (
   SEQUENCIA INT PRIMARY KEY, 
   ID_NOTA_FISCAL INT NOT NULL,
   QUANTIDADE FLOAT NOT NULL,  
   VALORUNITARIO FLOAT NOT NULL,
   ID_PRODUTO INT NOT NULL,
   CONSTRAINT FK_NOTADET FOREIGN KEY(ID_NOTA_FISCAL) 
      REFERENCES NOTAFISCAL(ID),
   CONSTRAINT FK_NOTAPROD FOREIGN KEY(ID_PRODUTO) 
      REFERENCES PRODUTO(ID)
);




INSERT INTO FORNECEDOR (ID,FORNOME) VALUES (20,'FORNECEDOR FOR#1');
INSERT INTO FORNECEDOR (ID,FORNOME) VALUES (30,'FORNECEDOR FOR#2');
INSERT INTO FORNECEDOR (ID,FORNOME) VALUES (40,'FORNECEDOR FOR#3');
INSERT INTO FORNECEDOR (ID,FORNOME) VALUES (50,'FORNECEDOR FOR#4');
INSERT INTO FORNECEDOR (ID,FORNOME) VALUES (60,'FORNECEDOR FOR#5');






INSERT INTO PRODUTO(ID,PRONOME,ID_FORNECEDOR,PROVLRUNITARIO) VALUES
(100,'PRODUTO PRO#1',20,10.55);
INSERT INTO PRODUTO(ID,PRONOME,ID_FORNECEDOR,PROVLRUNITARIO) VALUES
(101,'PRODUTO PRO#2',20,2.30);
INSERT INTO PRODUTO(ID,PRONOME,ID_FORNECEDOR,PROVLRUNITARIO) VALUES
(102,'PRODUTO PRO#3',30,15.10);
INSERT INTO PRODUTO(ID,PRONOME,ID_FORNECEDOR,PROVLRUNITARIO) VALUES
(103,'PRODUTO PRO#4',20,98.00);
INSERT INTO PRODUTO(ID,PRONOME,ID_FORNECEDOR,PROVLRUNITARIO) VALUES
(104,'PRODUTO PRO#5',40,100.00);
INSERT INTO PRODUTO(ID,PRONOME,ID_FORNECEDOR,PROVLRUNITARIO) VALUES
(106,'PRODUTO PRO#6',20,101.50);
INSERT INTO PRODUTO(ID,PRONOME,ID_FORNECEDOR,PROVLRUNITARIO) VALUES
(107,'PRODUTO PRO#7',60,25.66);
INSERT INTO PRODUTO(ID,PRONOME,ID_FORNECEDOR,PROVLRUNITARIO) VALUES
(108,'PRODUTO PRO#8',50,30.31);
INSERT INTO PRODUTO(ID,PRONOME,ID_FORNECEDOR,PROVLRUNITARIO) VALUES
(109,'PRODUTO PRO#90',40,60.66);
INSERT INTO PRODUTO(ID,PRONOME,ID_FORNECEDOR,PROVLRUNITARIO) VALUES
(110,'PRODUTO PRO#80',20,70.13);
INSERT INTO PRODUTO(ID,PRONOME,ID_FORNECEDOR,PROVLRUNITARIO) VALUES
(111,'PRODUTO PRO#108',30,82.30);


INSERT INTO CLIENTE(ID,CLINOME,CLIENDERECO,CLITELEFONE)
 VALUES (108,'CLIENTE CLI#1',NULL,NULL);
INSERT INTO CLIENTE(ID,CLINOME,CLIENDERECO,CLITELEFONE)
 VALUES (109,'CLIENTE CLI#2','RUA SAMARA 118','3248-6090');
INSERT INTO CLIENTE(ID,CLINOME,CLIENDERECO,CLITELEFONE)
 VALUES (110,'CLIENTE CLI#3',NULL,'3242-2525');
INSERT INTO CLIENTE(ID,CLINOME,CLIENDERECO,CLITELEFONE)
 VALUES (111,'CLIENTE CLI#4',NULL,NULL);
INSERT INTO CLIENTE(ID,CLINOME,CLIENDERECO,CLITELEFONE)
VALUES (112,'CLIENTE CLI#5','RUA BITUVAS 110',NULL);
INSERT INTO CLIENTE(ID,CLINOME,CLIENDERECO,CLITELEFONE)
 VALUES (113,'CLIENTE CLI#6','RUA DOS MORCEGOS','9141-2626');
INSERT INTO CLIENTE(ID,CLINOME,CLIENDERECO,CLITELEFONE)
 VALUES (114,'CLIENTE CLI#7','AV. 7 SETEMBRO 77','3247-7777');
INSERT INTO CLIENTE(ID,CLINOME,CLIENDERECO,CLITELEFONE)
 VALUES (115,'CLIENTE CLI#8','AV. 4 JULHO 1973',NULL);
INSERT INTO CLIENTE(ID,CLINOME,CLIENDERECO,CLITELEFONE)
 VALUES (116,'CLIENTE CLI#9',NULL,NULL);

 
INSERT INTO NOTAFISCAL(ID,NOTAEMISSAO,ID_CLIENTE)
 VALUES (300,'12/12/2003',108);
INSERT INTO NOTAFISCAL(ID,NOTAEMISSAO,ID_CLIENTE)
 VALUES (400,'15/02/2002',112);
INSERT INTO NOTAFISCAL(ID,NOTAEMISSAO,ID_CLIENTE)
 VALUES (500,'05/02/2011',115);
INSERT INTO NOTAFISCAL(ID,NOTAEMISSAO,ID_CLIENTE)
 VALUES (600,'03/06/2011',112);
INSERT INTO NOTAFISCAL(ID,NOTAEMISSAO,ID_CLIENTE)
 VALUES (701,'04/09/2012',114);


 INSERT INTO
NOTADETALHE(ID_NOTA_FISCAL, SEQUENCIA, QUANTIDADE, VALORUNITARIO, ID_PRODUTO) VALUES (300,1,2.0,20.53,111);
INSERT INTO
NOTADETALHE(ID_NOTA_FISCAL, SEQUENCIA, QUANTIDADE, VALORUNITARIO, ID_PRODUTO)  VALUES (300,2,3.0,19.90,110);
INSERT INTO
NOTADETALHE(ID_NOTA_FISCAL, SEQUENCIA, QUANTIDADE, VALORUNITARIO, ID_PRODUTO) VALUES (300,3,1.0,19.90,101);
INSERT INTO
NOTADETALHE(ID_NOTA_FISCAL, SEQUENCIA, QUANTIDADE, VALORUNITARIO, ID_PRODUTO)  VALUES (400,4,2.0,20.53,109);
INSERT INTO
NOTADETALHE(ID_NOTA_FISCAL, SEQUENCIA, QUANTIDADE, VALORUNITARIO, ID_PRODUTO)  VALUES (400,5,3.0,19.90,103);
INSERT INTO
NOTADETALHE(ID_NOTA_FISCAL, SEQUENCIA, QUANTIDADE, VALORUNITARIO, ID_PRODUTO)  VALUES (400,6,1.0,19.90,104);
INSERT INTO
NOTADETALHE(ID_NOTA_FISCAL, SEQUENCIA, QUANTIDADE, VALORUNITARIO, ID_PRODUTO)  VALUES (400,7,1.0,35.00,106);
INSERT INTO
NOTADETALHE(ID_NOTA_FISCAL, SEQUENCIA, QUANTIDADE, VALORUNITARIO, ID_PRODUTO)  VALUES (500,8,1.0,10.53,102);
INSERT INTO
NOTADETALHE(ID_NOTA_FISCAL, SEQUENCIA, QUANTIDADE, VALORUNITARIO, ID_PRODUTO)  VALUES (500,9,5.0,19.90,109);
INSERT INTO
NOTADETALHE(ID_NOTA_FISCAL, SEQUENCIA, QUANTIDADE, VALORUNITARIO, ID_PRODUTO)  VALUES (500,10,6.0,19.90,110);
INSERT INTO
NOTADETALHE(ID_NOTA_FISCAL, SEQUENCIA, QUANTIDADE, VALORUNITARIO, ID_PRODUTO)  VALUES (500,11,2.5,21.35,102);
INSERT INTO
NOTADETALHE(ID_NOTA_FISCAL, SEQUENCIA, QUANTIDADE, VALORUNITARIO, ID_PRODUTO)  VALUES (500,12,8.0,35.00,106);
INSERT INTO
NOTADETALHE(ID_NOTA_FISCAL, SEQUENCIA, QUANTIDADE, VALORUNITARIO, ID_PRODUTO)  VALUES (600,13,2.0,10.55,100);
INSERT INTO
NOTADETALHE(ID_NOTA_FISCAL, SEQUENCIA, QUANTIDADE, VALORUNITARIO, ID_PRODUTO)  VALUES (600,14,3.0,17.90,101);
INSERT INTO
NOTADETALHE(ID_NOTA_FISCAL, SEQUENCIA, QUANTIDADE, VALORUNITARIO, ID_PRODUTO)  VALUES (600,15,7.0,15.50,110);
INSERT INTO
NOTADETALHE(ID_NOTA_FISCAL, SEQUENCIA, QUANTIDADE, VALORUNITARIO, ID_PRODUTO)  VALUES (600,16,3.5,21.35,103);
INSERT INTO
NOTADETALHE(ID_NOTA_FISCAL, SEQUENCIA, QUANTIDADE, VALORUNITARIO, ID_PRODUTO)  VALUES (600,17,1.0,36.00,107);
INSERT INTO
NOTADETALHE(ID_NOTA_FISCAL, SEQUENCIA, QUANTIDADE, VALORUNITARIO, ID_PRODUTO)  VALUES (600,18,1.0,36.00,107);
INSERT INTO
NOTADETALHE(ID_NOTA_FISCAL, SEQUENCIA, QUANTIDADE, VALORUNITARIO, ID_PRODUTO)  VALUES (701,19,2.0,10.55,100);
INSERT INTO
NOTADETALHE(ID_NOTA_FISCAL, SEQUENCIA, QUANTIDADE, VALORUNITARIO, ID_PRODUTO)  VALUES (701,20,3.0,17.90,101);



--atividade 

--1)


SELECT p.PRONOME, f.FORNOME, p.PROVLRUNITARIO
FROM PRODUTO p INNER JOIN FORNECEDOR f
ON p.ID_FORNECEDOR = f.ID
WHERE p.PROVLRUNITARIO > (SELECT AVG(PROVLRUNITARIO) FROM PRODUTO)



--2


SELECT nf.NOTAEMISSAO, c.CLINOME  
FROM NOTAFISCAL nf INNER JOIN CLIENTE c
ON nf.ID_CLIENTE = c.ID
WHERE c.CLINOME NOT LIKE 'Carlos%'
AND c.CLITELEFONE IS NULL



--3

SELECT nf.ID, SUM(nd.QUANTIDADE * nd.VALORUNITARIO) AS VALOR_TOTAL, c.CLINOME  
FROM NOTADETALHE nd
INNER JOIN NOTAFISCAL nf ON nd.ID_NOTA_FISCAL = nf.ID  
INNER JOIN CLIENTE c ON nf.ID_CLIENTE = c.ID
GROUP BY nf.ID, c.CLINOME


--4

SELECT p.PRONOME, SUM(nd.QUANTIDADE) AS QUANTIDADE
FROM NOTADETALHE nd 
INNER JOIN PRODUTO p ON nd.ID_PRODUTO = p.ID
GROUP BY p.PRONOME
ORDER BY SUM(nd.QUANTIDADE) DESC

--5
SELECT c.CLINOME
FROM CLIENTE c LEFT JOIN NOTAFISCAL nf  
ON c.ID = nf.ID_CLIENTE
WHERE nf.ID IS NULL
ORDER BY c.CLINOME


--6
SELECT MAX(soma.VALOR_TOTAL) AS MAIOR_NOTA, 
  MAX(c.CLINOME) AS CLINOME
FROM (
  SELECT nf.ID_CLIENTE, SUM(nd.QUANTIDADE * nd.VALORUNITARIO) AS VALOR_TOTAL
  FROM NOTADETALHE nd
  INNER JOIN NOTAFISCAL nf ON nd.ID_NOTA_FISCAL = nf.ID
  GROUP BY nf.ID_CLIENTE    
) soma
INNER JOIN CLIENTE c ON soma.ID_CLIENTE = c.ID